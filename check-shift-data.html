<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班次数据检查工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .logs {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: green;
        }
        .warning {
            color: orange;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>班次数据检查工具</h1>
        <button class="button" id="checkShiftsBtn">检查班次数据</button>
        <button class="button" id="fixShiftsBtn">修复班次数据</button>
        <button class="button" id="printAllShiftsBtn">显示所有班次</button>
        <div class="logs" id="logs"></div>
    </div>

    <script>
        // 日志记录函数
        function log(message, type = 'info') {
            const logsElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logsElement.appendChild(logEntry);
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        // 打开IndexedDB数据库
        function openDatabase() {
            return new Promise((resolve, reject) => {
                // 更新版本号为10，与现有数据库版本匹配
                const request = indexedDB.open('scheduleSystemDB', 10);
                
                request.onerror = () => {
                    log(`数据库打开失败: ${request.error.message}`, 'error');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    log('数据库打开成功', 'success');
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // 检查并创建shifts存储
                    if (!db.objectStoreNames.contains('shifts')) {
                        const shiftsStore = db.createObjectStore('shifts', { keyPath: 'id', autoIncrement: true });
                        shiftsStore.createIndex('name', 'name', { unique: false });
                        shiftsStore.createIndex('enabled', 'enabled', { unique: false });
                        log('创建shifts存储空间', 'success');
                    }
                };
            });
        }

        // 检查班次数据
        async function checkShiftsData() {
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['shifts'], 'readonly');
                const store = transaction.objectStore('shifts');
                const allShifts = await store.getAll();
                
                log(`数据库中共有 ${allShifts.length} 个班次记录`);
                
                // 统计启用的班次
                const enabledShifts = allShifts.filter(shift => shift.enabled);
                log(`其中启用的班次有 ${enabledShifts.length} 个`);
                
                // 检查非休班次
                const nonRestShifts = allShifts.filter(shift => shift.name && shift.name !== '休');
                log(`非休班次有 ${nonRestShifts.length} 个`);
                
                // 检查启用的非休班次
                const enabledNonRestShifts = nonRestShifts.filter(shift => shift.enabled);
                log(`启用的非休班次有 ${enabledNonRestShifts.length} 个`, 
                    enabledNonRestShifts.length > 0 ? 'success' : 'warning');
                
                if (enabledNonRestShifts.length === 0) {
                    log('警告：数据库中没有启用的非休班次，这会导致排班结果只显示"休"班次', 'warning');
                } else {
                    log('启用的非休班次列表:', 'success');
                    enabledNonRestShifts.forEach(shift => {
                        log(`- ${shift.name} (ID: ${shift.id})`);
                    });
                }
                
                db.close();
            } catch (error) {
                log(`检查班次数据时出错: ${error.message}`, 'error');
            }
        }

        // 修复班次数据
        async function fixShiftsData() {
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['shifts'], 'readwrite');
                const store = transaction.objectStore('shifts');
                const allShifts = await store.getAll();
                
                // 定义默认班次数据
                const defaultShifts = [
                    { name: '休', enabled: true, isRestDay: true, priority: 100 },
                    { name: 'G早', enabled: true, isRestDay: false, priority: 1 },
                    { name: 'G中', enabled: true, isRestDay: false, priority: 1 },
                    { name: 'G晚', enabled: true, isRestDay: false, priority: 1 },
                    { name: 'Y早', enabled: true, isRestDay: false, priority: 2 },
                    { name: 'Y中', enabled: true, isRestDay: false, priority: 2 },
                    { name: 'Y晚', enabled: true, isRestDay: false, priority: 2 }
                ];
                
                log('开始修复班次数据...');
                
                // 检查并添加缺失的默认班次
                for (const defaultShift of defaultShifts) {
                    const existingShifts = await store.getAll(IDBKeyRange.only(defaultShift.name), 'name');
                    const existingShift = existingShifts.find(s => s.name === defaultShift.name);
                    
                    if (existingShift) {
                        // 更新现有班次，确保启用
                        if (!existingShift.enabled) {
                            existingShift.enabled = true;
                            await store.put(existingShift);
                            log(`已启用班次: ${existingShift.name} (ID: ${existingShift.id})`, 'success');
                        } else {
                            log(`班次 ${existingShift.name} 已启用，无需修改`);
                        }
                    } else {
                        // 添加新班次
                        const addResult = await store.add(defaultShift);
                        log(`已添加新班次: ${defaultShift.name} (ID: ${addResult})`, 'success');
                    }
                }
                
                // 确保所有班次都有enabled属性
                for (const shift of allShifts) {
                    if (shift.enabled === undefined) {
                        shift.enabled = true;
                        await store.put(shift);
                        log(`已更新班次属性: ${shift.name} (ID: ${shift.id})`, 'success');
                    }
                }
                
                await transaction.complete;
                log('班次数据修复完成!', 'success');
                db.close();
                
                // 修复后重新检查
                setTimeout(checkShiftsData, 1000);
            } catch (error) {
                log(`修复班次数据时出错: ${error.message}`, 'error');
            }
        }

        // 显示所有班次数据
        async function printAllShifts() {
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['shifts'], 'readonly');
                const store = transaction.objectStore('shifts');
                const allShifts = await store.getAll();
                
                log('所有班次数据:');
                allShifts.forEach(shift => {
                    const status = shift.enabled ? '已启用' : '已禁用';
                    const type = shift.isRestDay ? '休息日' : '工作日';
                    log(`- ID: ${shift.id}, 名称: ${shift.name}, 状态: ${status}, 类型: ${type}, 优先级: ${shift.priority || '未设置'}`);
                });
                
                db.close();
            } catch (error) {
                log(`获取所有班次数据时出错: ${error.message}`, 'error');
            }
        }

        // 绑定按钮事件
        document.getElementById('checkShiftsBtn').addEventListener('click', checkShiftsData);
        document.getElementById('fixShiftsBtn').addEventListener('click', fixShiftsData);
        document.getElementById('printAllShiftsBtn').addEventListener('click', printAllShifts);
    </script>
</body>
</html>