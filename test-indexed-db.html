<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB测试页面</title>
    <link rel="stylesheet" href="css/institution-styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>IndexedDB测试页面</h1>
        <p>此页面用于测试智能排班表应用的IndexedDB数据存储功能</p>

        <div class="test-section">
            <h2>1. 数据库初始化</h2>
            <div class="button-group">
                <button id="initDbBtn" class="btn-primary">初始化数据库</button>
                <button id="migrateBtn" class="btn-secondary">从localStorage迁移数据</button>
            </div>
        </div>

        <div class="test-section">
            <h2>2. 机构数据操作</h2>
            <div class="button-group">
                <button id="addOrgBtn" class="btn-primary">添加测试机构</button>
                <button id="getAllOrgsBtn" class="btn-secondary">获取所有机构</button>
                <button id="clearOrgsBtn" class="btn-danger">清空机构数据</button>
            </div>
        </div>

        <div class="test-section">
            <h2>3. 数据导入导出</h2>
            <div class="button-group">
                <button id="exportBtn" class="btn-primary">导出数据</button>
                <input type="file" id="importFile" accept=".json">
                <button id="importBtn" class="btn-secondary">导入数据</button>
            </div>
        </div>

        <div class="test-section">
            <h2>操作日志</h2>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script type="module">
        // 导入IndexedDB管理器
        import dbManager from './js/indexed-db-manager.js';

        // 日志容器
        const logContainer = document.getElementById('logContainer');

        // 添加日志函数
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 初始化数据库按钮
        document.getElementById('initDbBtn').addEventListener('click', async () => {
            try {
                addLog('开始初始化数据库...');
                await dbManager.initDB();
                addLog('数据库初始化成功!', 'success');
                addLog(`数据库名称: ${dbManager.dbName}, 版本: ${dbManager.dbVersion}`);
            } catch (error) {
                addLog(`数据库初始化失败: ${error.message}`, 'error');
            }
        });

        // 迁移数据按钮
        document.getElementById('migrateBtn').addEventListener('click', async () => {
            try {
                addLog('开始从localStorage迁移数据...');
                const result = await dbManager.migrateFromLocalStorage();
                if (result) {
                    addLog('数据迁移成功!', 'success');
                } else {
                    addLog('数据已迁移或无需迁移', 'info');
                }
            } catch (error) {
                addLog(`数据迁移失败: ${error.message}`, 'error');
            }
        });

        // 添加测试机构按钮
        document.getElementById('addOrgBtn').addEventListener('click', async () => {
            try {
                addLog('开始添加测试机构...');
                const testOrg = {
                    name: '测试机构' + Math.floor(Math.random() * 1000),
                    code: Math.floor(1000 + Math.random() * 9000).toString(),
                    description: '这是一个测试机构',
                    remark: '测试数据',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    status: 'active'
                };
                await dbManager.save('organizations', testOrg);
                addLog(`测试机构添加成功: ${testOrg.name} (${testOrg.code})`, 'success');
            } catch (error) {
                addLog(`添加测试机构失败: ${error.message}`, 'error');
            }
        });

        // 获取所有机构按钮
        document.getElementById('getAllOrgsBtn').addEventListener('click', async () => {
            try {
                addLog('开始获取所有机构...');
                const organizations = await dbManager.getAll('organizations');
                addLog(`获取成功，共 ${organizations.length} 个机构`, 'success');
                if (organizations.length > 0) {
                    addLog('机构列表:');
                    organizations.forEach(org => {
                        addLog(`- ${org.name} (${org.code}) - ${org.status}`);
                    });
                }
            } catch (error) {
                addLog(`获取机构失败: ${error.message}`, 'error');
            }
        });

        // 清空机构数据按钮
        document.getElementById('clearOrgsBtn').addEventListener('click', async () => {
            if (confirm('确定要清空所有机构数据吗？')) {
                try {
                    addLog('开始清空机构数据...');
                    await dbManager.clearStore('organizations');
                    addLog('机构数据已清空', 'success');
                } catch (error) {
                    addLog(`清空机构数据失败: ${error.message}`, 'error');
                }
            }
        });

        // 导出数据按钮
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                addLog('开始导出数据...');
                const exportData = await dbManager.exportDatabaseData();
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `schedule-data-export-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                addLog('数据导出成功!', 'success');
            } catch (error) {
                addLog(`数据导出失败: ${error.message}`, 'error');
            }
        });

        // 导入数据按钮
        document.getElementById('importBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                addLog('请先选择要导入的JSON文件', 'error');
                return;
            }

            if (confirm('确定要导入数据吗？这将覆盖现有数据！')) {
                try {
                    addLog('开始导入数据...');
                    const file = fileInput.files[0];
                    const reader = new FileReader();

                    reader.onload = async (event) => {
                        try {
                            const jsonData = JSON.parse(event.target.result);
                            await dbManager.importData(jsonData);
                            addLog('数据导入成功!', 'success');
                        } catch (error) {
                            addLog(`解析或导入数据失败: ${error.message}`, 'error');
                        }
                    };

                    reader.onerror = () => {
                        addLog('读取文件失败', 'error');
                    };

                    reader.readAsText(file);
                } catch (error) {
                    addLog(`数据导入失败: ${error.message}`, 'error');
                }
            }
        });

        // 页面加载时自动初始化数据库
        window.addEventListener('load', async () => {
            addLog('页面加载完成，尝试自动初始化数据库...');
            try {
                await dbManager.initDB();
                addLog('数据库已自动初始化成功!', 'success');
            } catch (error) {
                addLog(`自动初始化数据库失败: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>