<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检查排班顺序数据</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .button-group {
            text-align: center;
            margin: 30px 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result-area {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
        }
        .explanation {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .step {
            margin: 15px 0;
            padding-left: 20px;
            border-left: 3px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>检查排班顺序数据</h1>
        
        <div class="explanation">
            <h3>功能说明</h3>
            <p>这个页面可以帮助您检查数据库中是否存在排班顺序数据，并解释为什么导出数据时shiftOrders字段会包含数据。</p>
        </div>
        
        <div class="button-group">
            <button id="checkButton">检查排班顺序数据</button>
        </div>
        
        <div class="result-area" id="resultArea">
            点击上方按钮开始检查...
        </div>
        
        <div class="explanation">
            <h3>导出数据时shiftOrders包含数据的原因</h3>
            <div class="step">
                <p><strong>1. 导出逻辑设计</strong></p>
                <p>根据代码分析，系统在导出数据时会主动包含shiftOrders存储空间的数据。这是在<code>indexed-db-manager.js</code>的<code>exportDatabaseData</code>方法中明确指定的。</p>
            </div>
            <div class="step">
                <p><strong>2. 数据结构处理</strong></p>
                <p>导出过程中会对shiftOrders数据进行特殊处理：</p>
                <ul>
                    <li>优先使用<code>employeeNumbers</code>字段</li>
                    <li>移除可能存在的<code>employeeIds</code>字段</li>
                    <li>确保数据格式的一致性</li>
                </ul>
            </div>
            <div class="step">
                <p><strong>3. 空数据处理</strong></p>
                <p>即使数据库中没有排班顺序数据，导出的JSON文件中仍然会包含一个空的<code>shiftOrders</code>数组，这是为了保持数据结构的完整性。</p>
            </div>
        </div>
        
        <div class="note">
            <p><strong>注意事项：</strong></p>
            <ul>
                <li>如果页面显示"dbManager未初始化"，请先打开主应用页面加载必要的JavaScript文件</li>
                <li>检查结果将显示在上方的结果区域</li>
                <li>如果您对数据有疑问，可以联系系统管理员进行进一步检查</li>
            </ul>
        </div>
    </div>

    <script>
        // 重写console.log以便在页面上显示结果
        const originalConsoleLog = console.log;
        const resultArea = document.getElementById('resultArea');
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            
            // 将日志转换为字符串并添加到结果区域
            const logText = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');
            
            resultArea.textContent += logText + '\n';
            resultArea.scrollTop = resultArea.scrollHeight; // 自动滚动到底部
        };
        
        // 检查按钮点击事件
        document.getElementById('checkButton').addEventListener('click', async function() {
            resultArea.textContent = '开始检查数据库中的排班顺序数据...\n';
            
            try {
                // 检查是否可以直接访问dbManager
                if (window.dbManager) {
                    console.log('dbManager已初始化，可以直接检查数据');
                    await checkShiftOrderData();
                } else {
                    console.log('dbManager未初始化，尝试加载必要的JavaScript文件...');
                    
                    // 这里需要根据实际项目结构调整文件路径
                    try {
                        // 动态加载indexed-db-manager.js
                        const dbManagerScript = document.createElement('script');
                        dbManagerScript.src = './js/indexed-db-manager.js';
                        
                        await new Promise((resolve, reject) => {
                            dbManagerScript.onload = resolve;
                            dbManagerScript.onerror = reject;
                            document.head.appendChild(dbManagerScript);
                        });
                        
                        console.log('indexed-db-manager.js加载成功');
                        
                        // 等待dbManager初始化
                        setTimeout(async () => {
                            if (window.dbManager) {
                                await checkShiftOrderData();
                            } else {
                                console.log('无法初始化dbManager，请先打开主应用页面');
                                console.log('建议：先打开智能排班表主页面，再刷新此页面');
                            }
                        }, 1000);
                    } catch (error) {
                        console.error('加载JavaScript文件时出错:', error);
                        console.log('请先打开智能排班表主页面，然后再刷新此页面');
                    }
                }
            } catch (error) {
                console.error('检查过程中发生错误:', error);
            }
        });
        
        // 检查排班顺序数据的函数
        async function checkShiftOrderData() {
            try {
                // 检查dbManager是否已初始化
                if (!window.dbManager) {
                    console.error('dbManager尚未初始化，无法检查排班顺序数据');
                    return;
                }
                
                // 检查shiftOrders存储空间是否存在
                console.log('检查shiftOrders存储空间是否存在...');
                
                // 尝试获取所有排班顺序数据（作为检查存储空间存在的方式）
                try {
                    const allShiftOrders = await window.dbManager.getAll('shiftOrders');
                    console.log('数据库中排班顺序数据总数:', allShiftOrders ? allShiftOrders.length : 0);
                    
                    if (allShiftOrders && allShiftOrders.length > 0) {
                        console.log('部分排班顺序数据示例:');
                        // 显示前3条数据作为示例
                        const sampleData = allShiftOrders.slice(0, 3);
                        sampleData.forEach((order, index) => {
                            console.log(`\n示例 ${index + 1}:`);
                            console.log(`  岗位: ${order.position || '无'}`);
                            console.log(`  班次代码: ${order.shiftCode || '无'}`);
                            console.log(`  是否为剔除列表: ${order.excludeAllEmployees ? '是' : '否'}`);
                            console.log(`  员工号数量: ${order.employeeNumbers ? order.employeeNumbers.length : 0}`);
                            if (order.employeeNumbers && order.employeeNumbers.length > 0) {
                                console.log(`  员工号列表: ${order.employeeNumbers.join(', ')}`);
                            }
                        });
                    } else {
                        console.log('数据库中没有排班顺序数据');
                    }
                } catch (error) {
                    console.log('shiftOrders存储空间可能不存在或无法访问:', error.message);
                }
                
                // 导出时为何会有数据的解释
                console.log('\n导出数据时shiftOrders包含数据的原因:');
                console.log('1. 在indexed-db-manager.js中的exportDatabaseData方法会主动导出shiftOrders数据');
                console.log('2. 导出时会对shiftOrders数据进行特殊处理，优先使用employeeNumbers字段');
                console.log('3. 即使数据库中没有数据，导出JSON文件中也会包含空的shiftOrders数组');
                console.log('4. 这是系统设计的一部分，确保导出的数据结构完整性');
                
            } catch (error) {
                console.error('检查排班顺序数据时发生错误:', error);
            }
        }
    </script>
</body>
</html>